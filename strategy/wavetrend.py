#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
============================================================
WaveTrend (LazyBear) æŒ‡æ ‡ - Python å®Œæ•´å®ç°

åŠŸèƒ½:
1. è®¡ç®— wt1 / wt2 / wt_diff
2. è¯†åˆ«é‡‘å‰ / æ­»å‰ä¿¡å·
3. å‚æ•°é›†ä¸­é…ç½®ï¼ˆç±»ä¼¼ TradingView inputï¼‰
4. è¾“å‡ºæ¯æ—¥çº¢ç»¿ç‚¹ä¿¡å·

ä½œè€…: ä½ è‡ªå·±ï¼ˆåŸºäº LazyBear æ€è·¯ï¼‰
============================================================
"""

import pandas as pd
import numpy as np
from api.stock_query import stock_zh_a_daily_mysql


# ------------------------------------------------------------
# Pandas æ˜¾ç¤ºè®¾ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
# ------------------------------------------------------------
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)
pd.set_option('display.width', None)


# ============================================================
# WaveTrend æŒ‡æ ‡è®¡ç®—å‡½æ•°ï¼ˆæ ¸å¿ƒï¼‰
# ============================================================
def wavetrend(df, config):
    """
    WaveTrend (LazyBear) æŒ‡æ ‡è®¡ç®—

    å‚æ•°è¯´æ˜ï¼ˆå®Œå…¨å¯¹åº” TradingView inputï¼‰:
    ------------------------------------------------
    n1      : Channel Length
    n2      : Average Length
    ma_len  : wt2 å¹³æ»‘å‘¨æœŸï¼ˆLazyBear å›ºå®šä¸º 4ï¼‰
    ob1     : è¶…ä¹°çº¿ 1ï¼ˆç”»çº¿ / è¿‡æ»¤ç”¨ï¼‰
    ob2     : è¶…ä¹°çº¿ 2
    os1     : è¶…å–çº¿ 1
    os2     : è¶…å–çº¿ 2

    è¿”å›:
    ------------------------------------------------
    åœ¨ df ä¸­æ–°å¢ä»¥ä¸‹åˆ—:
    wt1        ä¸»çº¿ï¼ˆtciï¼‰
    wt2        ä¿¡å·çº¿
    wt_diff    åŠ¨èƒ½æŸ±ï¼ˆwt1 - wt2ï¼‰
    wt_signal  ä¿¡å·:
                1  -> ç»¿è‰²ç‚¹ï¼ˆé‡‘å‰ï¼‰
               -1  -> çº¢è‰²ç‚¹ï¼ˆæ­»å‰ï¼‰
                0  -> æ— ä¿¡å·
    """

    # ---------- è¯»å–å‚æ•° ----------
    n1 = config.get('n1', 10)
    n2 = config.get('n2', 21)
    ma_len = config.get('ma_len', 4)

    # ---------- HLC3 (TradingView: hlc3) ----------
    # ç”¨äºå¹³æ»‘ä»·æ ¼ï¼Œå‡å°‘å•ä¸€ close å™ªå£°
    ap = (df['high'] + df['low'] + df['close']) / 3

    # ---------- ESA (EMA of price) ----------
    # ç±»ä¼¼â€œä»·æ ¼åŸºå‡†çº¿â€
    esa = ap.ewm(span=n1, adjust=False).mean()

    # ---------- D (ä»·æ ¼åç¦»çš„ EMA) ----------
    # è¡¡é‡æ³¢åŠ¨å¼ºåº¦ï¼Œé¿å…é™¤ä»¥ 0
    d = (ap - esa).abs().ewm(span=n1, adjust=False).mean()

    # ---------- CI (Composite Index) ----------
    # æ ¸å¿ƒéœ‡è¡æº
    ci = (ap - esa) / (0.015 * d)

    # ---------- WT1 (ä¸»çº¿) ----------
    wt1 = ci.ewm(span=n2, adjust=False).mean()

    # ---------- WT2 (ä¿¡å·çº¿) ----------
    wt2 = wt1.rolling(window=ma_len).mean()

    # ---------- WT å·®å€¼ï¼ˆè“è‰²åŠ¨èƒ½æŸ±ï¼‰ ----------
    wt_diff = wt1 - wt2

    # ---------- äº¤å‰åˆ¤æ–­ ----------
    # é‡‘å‰ï¼šwt1 ä»ä¸‹å‘ä¸Šç©¿è¿‡ wt2
    cross_up = (wt1.shift(1) < wt2.shift(1)) & (wt1 > wt2)

    # æ­»å‰ï¼šwt1 ä»ä¸Šå‘ä¸‹ç©¿è¿‡ wt2
    cross_down = (wt1.shift(1) > wt2.shift(1)) & (wt1 < wt2)

    # ---------- ä¿¡å·ç¼–ç  ----------
    signal = np.where(
        cross_up, 1,
        np.where(cross_down, -1, 0)
    )

    # ---------- å†™å› DataFrame ----------
    df['wt1'] = wt1
    df['wt2'] = wt2
    df['wt_diff'] = wt_diff
    df['wt_signal'] = signal

    return df


# ============================================================
# ä¸»ç¨‹åºå…¥å£
# ============================================================
def main():
    # --------------------------------------------------------
    # 1. è¯»å–æ—¥çº¿æ•°æ®
    # --------------------------------------------------------
    df = stock_zh_a_daily_mysql(
        symbol='sh600588',
        start_date='20240101',
        end_date='20251231',
        adjust='qfq'
    )

    if df is None or df.empty:
        print("æ•°æ®ä¸ºç©º")
        return

    # å­—æ®µç»Ÿä¸€å°å†™ï¼Œé¿å…ä¸åŒæ•°æ®æºä¸ä¸€è‡´
    df.columns = [c.lower() for c in df.columns]

    # --------------------------------------------------------
    # 2. WaveTrend å‚æ•°é…ç½®åŒºï¼ˆåƒ TradingView inputï¼‰
    # --------------------------------------------------------
    wt_config = {
        "n1": 10,     # Channel Length
        "n2": 21,     # Average Length
        "ma_len": 4,  # wt2 å¹³æ»‘å‘¨æœŸ
        "ob1": 60,    # è¶…ä¹°çº¿ 1
        "ob2": 53,
        "os1": -60,   # è¶…å–çº¿ 1
        "os2": -53,
    }

    # --------------------------------------------------------
    # 3. è®¡ç®— WaveTrend
    # --------------------------------------------------------
    df = wavetrend(df, wt_config)

    # --------------------------------------------------------
    # 4. åªä¿ç•™æœ‰çº¢ç»¿ç‚¹çš„æ—¥æœŸ
    # --------------------------------------------------------
    signal_df = df[df['wt_signal'] != 0][
        ['date', 'close', 'wt1', 'wt2', 'wt_diff', 'wt_signal']
    ].copy()

    # --------------------------------------------------------
    # 5. æ˜¾ç¤ºå±‚ï¼šç»Ÿä¸€ä¿ç•™ä¸¤ä½å°æ•°
    # --------------------------------------------------------
    for col in ['close', 'wt1', 'wt2', 'wt_diff']:
        signal_df[col] = signal_df[col].round(2)

    # --------------------------------------------------------
    # 6. ä¿¡å·å¯è¯»åŒ–
    # --------------------------------------------------------
    signal_df['signal_text'] = signal_df['wt_signal'].map({
        1: 'ğŸŸ¢ çœ‹å¤šï¼ˆç»¿è‰²ç‚¹ï¼‰',
       -1: 'ğŸ”´ çœ‹ç©ºï¼ˆçº¢è‰²ç‚¹ï¼‰'
    })

    # --------------------------------------------------------
    # 7. è¾“å‡ºç»“æœ
    # --------------------------------------------------------
    print(signal_df)


# ============================================================
# ç¨‹åºå…¥å£
# ============================================================
if __name__ == "__main__":
    main()
