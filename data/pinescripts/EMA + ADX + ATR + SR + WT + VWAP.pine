// =====================================================
// EMA
// + ADX Trend Strength
// + ATR Stop Loss Finder
// + S/R Levels [LuxAlgo Integrated]
// + WaveTrend Bar Color [LazyBear Logic]
// + Multi EMA Extension
// + VWAP Stdev Bands Integrated
// =====================================================

//@version=6
indicator("EMA + ADX + ATR + SR + WT + VWAP", overlay = true, max_bars_back=1000)

// =====================================================
// ================= 1. 支撑压力位参数 ==================
// =====================================================
group_sr    = "1. Support & Resistance"
showSR      = input.bool(true, "显示 支撑/压力线", group=group_sr)
leftBars    = input.int(15, "左侧侧边栏 (Left Bars)", minval=1, group=group_sr)
rightBars   = input.int(15, "右侧侧边栏 (Right Bars)", minval=1, group=group_sr)
resColor    = input.color(color.new(#FF0000, 0), "压力线颜色", group=group_sr)
supColor    = input.color(color.new(#233dee, 0), "支撑线颜色", group=group_sr)

// =====================================================
// ================= 2. EMA 参数 =======================
// =====================================================
group_ema   = "2. EMA Trend"
showEMA     = input.bool(true, "显示 EMA 组", group=group_ema)
ema_len     = input.int(200, "EMA 1 长度", minval = 1, group=group_ema)
ema_col     = input.color(color.orange, "EMA 1 颜色", group=group_ema)
ema2_len    = input.int(50, "EMA 2 长度", minval = 1, group=group_ema)
ema2_col    = input.color(#00ffff, "EMA 2 颜色", group=group_ema)
ema3_len    = input.int(100, "EMA 3 长度", minval = 1, group=group_ema)
ema3_col    = input.color(#ff00ff, "EMA 3 颜色", group=group_ema)

// =====================================================
// ================= 3. ADX 参数 =======================
// =====================================================
group_adx   = "3. ADX Strength (Background)"
showADX     = input.bool(true, "显示 ADX 趋势背景", group=group_adx)
adx_len     = input.int(14,  "ADX 长度", minval = 1, group=group_adx)
adx_th      = input.int(25,  "ADX 阈值", minval = 1, group=group_adx)
bg_col      = input.color(color.new(color.green, 85), "强趋势背景颜色", group=group_adx)

// =====================================================
// ================= 4. ATR 参数 =======================
// =====================================================
group_atr   = "4. ATR Stop Loss"
showATR     = input.bool(true, "显示 ATR 止损线", group=group_atr)
atr_len      = input.int(14, "ATR 长度", minval = 1, group=group_atr)
atr_mult     = input.float(1.5, "ATR 倍数", step = 0.1, group=group_atr)
atr_smooth   = input.string("RMA", "ATR 平滑算法", options = ["RMA", "SMA", "EMA", "WMA"], group=group_atr)
show_price_line = input.bool(true, "跟踪价格线 (Track Price Line)", group=group_atr)
showTable    = input.bool(true, "显示 ATR 信息表格", group=group_atr)
atr_col_long  = input.color(color.teal, "ATR 多头线颜色", group=group_atr)
atr_col_short = input.color(color.red,  "ATR 空头线颜色", group=group_atr)
atr_text_col  = input.color(color.blue, "表格文字颜色", group=group_atr)

// =====================================================
// ================= 5. WaveTrend 参数 =================
// =====================================================
group_wt     = "5. WaveTrend Bar Color"
showWTColor  = input.bool(true, "开启 WT 交叉柱体变色", group=group_wt)
wt_n1         = input.int(10, "WT 管道长度", group=group_wt)
wt_n2         = input.int(21, "WT 平均长度", group=group_wt)
color_bull   = input.color(color.yellow, "多头信号颜色 (Cross Up)", group=group_wt)
color_bear   = input.color(color.aqua,   "空头信号颜色 (Cross Down)", group=group_wt)

// =====================================================
// ================= 6. VWAP Stdev Bands ================
// =====================================================
group_vwap  = "6. VWAP Stdev Bands"
showVWAP    = input.bool(false, "开启 VWAP 标准差带", group=group_vwap)
devUp1      = input.float(1.28, "Stdev 1 (上)", group=group_vwap)
devDn1      = input.float(1.28, "Stdev 1 (下)", group=group_vwap)
devUp2      = input.float(2.01, "Stdev 2 (上)", group=group_vwap)
devDn2      = input.float(2.01, "Stdev 2 (下)", group=group_vwap)
devUp3      = input.float(2.51, "Stdev 3 (上)", group=group_vwap)
devDn3      = input.float(2.51, "Stdev 3 (下)", group=group_vwap)
devUp4      = input.float(3.09, "Stdev 4 (上)", group=group_vwap)
devDn4      = input.float(3.09, "Stdev 4 (下)", group=group_vwap)
showDv2     = input.bool(true,  "显示第二层带", group=group_vwap)
showDv3     = input.bool(true,  "显示第三层带", group=group_vwap)
showDv4     = input.bool(true,  "显示第四层带 (3.09)", group=group_vwap)
showVFill   = input.bool(true,  "显示背景填充", group=group_vwap)
showVBarCol = input.bool(false, "开启 VWAP 柱体变色", group=group_vwap)

// =====================================================
// ================= 核心逻辑计算 =======================
// =====================================================

// --- [S/R Levels] ---
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)
highLevel = ta.valuewhen(not na(ph), ph, 0)
lowLevel  = ta.valuewhen(not na(pl), pl, 0)
bool highChanged = ta.change(highLevel) != 0
bool lowChanged  = ta.change(lowLevel) != 0
plot(showSR and not highChanged ? highLevel : na, color=resColor, linewidth=3, offset=-(rightBars + 1), title="Resistance", style=plot.style_linebr)
plot(showSR and not lowChanged  ? lowLevel  : na, color=supColor, linewidth=3, offset=-(rightBars + 1), title="Support", style=plot.style_linebr)

// --- [EMA Group] ---
ema_val  = ta.ema(close, ema_len)
ema2_val = ta.ema(close, ema2_len)
ema3_val = ta.ema(close, ema3_len)
plot(showEMA ? ema_val  : na, "EMA 1", color = ema_col,  linewidth = 2)
plot(showEMA ? ema2_val : na, "EMA 2", color = ema2_col, linewidth = 2)
plot(showEMA ? ema3_val : na, "EMA 3", color = ema3_col, linewidth = 2)

// --- [ADX 背景] ---
tr_val = ta.tr(true)
dmPlus = (high - nz(high[1]) > nz(low[1]) - low) ? math.max(high - nz(high[1]), 0) : 0
dmMinus = (nz(low[1]) - low > high - nz(high[1])) ? math.max(nz(low[1]) - low, 0) : 0
trSmooth = ta.rma(tr_val, adx_len)
diPlus = 100 * ta.rma(dmPlus, adx_len) / trSmooth
diMinus = 100 * ta.rma(dmMinus, adx_len) / trSmooth
adx_val = ta.sma(100 * math.abs(diPlus - diMinus) / (diPlus + diMinus), adx_len)
bgcolor(showADX and adx_val > adx_th ? bg_col : na, title = "ADX Strong Trend BG")

// --- [ATR Stop Loss] ---
ma_func(src, len) =>
    switch atr_smooth
        "RMA" => ta.rma(src, len)
        "SMA" => ta.sma(src, len)
        "EMA" => ta.ema(src, len)
        => ta.wma(src, len)
atr_v = ma_func(ta.tr(true), atr_len) * atr_mult
atr_short = high + atr_v
atr_long  = low  - atr_v
plot(showATR ? atr_short : na, "ATR Short Stop", atr_col_short, linewidth = 1, trackprice = show_price_line)
plot(showATR ? atr_long : na, "ATR Long Stop", atr_col_long, linewidth = 1, trackprice = show_price_line)

// --- [WaveTrend] ---
ap = hlc3
esa = ta.ema(ap, wt_n1)
d_wt = ta.ema(math.abs(ap - esa), wt_n1)
ci = (ap - esa) / (0.015 * d_wt)
wt1 = ta.ema(ci, wt_n2)
wt2 = ta.sma(wt1, 4)
bool wtCross = ta.cross(wt1, wt2)
color wt_c = wtCross ? (wt2 - wt1 > 0 ? color_bear : color_bull) : na

// --- [VWAP Stdev Bands Logic] ---
var float vwapsum = 0.0
var float volumesum = 0.0
var float v2sum = 0.0
bool isNewSession = ta.change(time("D")) != 0

vwapsum := isNewSession ? hl2 * volume : vwapsum + hl2 * volume
volumesum := isNewSession ? volume : volumesum + volume
v2sum := isNewSession ? volume * math.pow(hl2, 2) : v2sum + volume * math.pow(hl2, 2)
myvwap = vwapsum / volumesum
dev = math.sqrt(math.max(v2sum / volumesum - math.pow(myvwap, 2), 0))

// VWAP Plots
p_vwap = plot(showVWAP ? myvwap : na, style=plot.style_circles, title="VWAP", color=color.black)
u1 = plot(showVWAP ? myvwap + devUp1 * dev : na, style=plot.style_circles, title="U1", color=color.gray)
d1 = plot(showVWAP ? myvwap - devDn1 * dev : na, style=plot.style_circles, title="D1", color=color.gray)
u2 = plot(showVWAP and showDv2 ? myvwap + devUp2 * dev : na, color=color.new(color.red, 0), title="U2")
d2 = plot(showVWAP and showDv2 ? myvwap - devDn2 * dev : na, color=color.new(color.green, 0), title="D2")
u3 = plot(showVWAP and showDv3 ? myvwap + devUp3 * dev : na, color=color.new(color.red, 0), title="U3")
d3 = plot(showVWAP and showDv3 ? myvwap - devDn3 * dev : na, color=color.new(color.green, 0), title="D3")
u4 = plot(showVWAP and showDv4 ? myvwap + devUp4 * dev : na, color=color.new(color.orange, 0), title="U4 (3.09)")
d4 = plot(showVWAP and showDv4 ? myvwap - devDn4 * dev : na, color=color.new(color.lime, 0), title="D4 (3.09)")

// VWAP Fills
fill(u1, u2, showVWAP and showVFill ? color.new(color.red, 90) : na, title="Fill U1-U2")
fill(d1, d2, showVWAP and showVFill ? color.new(color.green, 90) : na, title="Fill D1-D2")
fill(u2, u3, showVWAP and showVFill ? color.new(color.red, 90) : na, title="Fill U2-U3")
fill(d2, d3, showVWAP and showVFill ? color.new(color.green, 90) : na, title="Fill D2-D3")
fill(u3, u4, showVWAP and showVFill and showDv4 ? color.new(color.orange, 90) : na, title="Fill U3-U4")
fill(d3, d4, showVWAP and showVFill and showDv4 ? color.new(color.lime, 90) : na, title="Fill D3-D4")
fill(p_vwap, u1, showVWAP and showVFill ? color.new(color.gray, 92) : na, title="Fill Central Up")
fill(p_vwap, d1, showVWAP and showVFill ? color.new(color.gray, 92) : na, title="Fill Central Down")

// --- [Barcolor 混合逻辑] ---
color final_bar_color = na
if showWTColor and not na(wt_c)
    final_bar_color := wt_c
else if showVWAP and showVBarCol
    // 价格超出 3.09 倍标准差时加深颜色提示
    if close > myvwap + devUp4 * dev
        final_bar_color := color.purple
    else if close < myvwap - devDn4 * dev
        final_bar_color := color.blue
    else if close > myvwap + devUp2 * dev
        final_bar_color := color.maroon
    else if close < myvwap - devDn2 * dev
        final_bar_color := color.green

barcolor(final_bar_color)

// --- [ATR 信息表格] ---
var table infoTable = table.new(position.bottom_center, 3, 1, border_width = 2)
if barstate.islast and showTable
    table.cell(infoTable, 0, 0, "ATR: " + str.tostring(atr_v, "#.##"), text_color = atr_text_col)
    table.cell(infoTable, 1, 0, "H: " + str.tostring(atr_short, "#.##"), text_color = atr_col_short)
    table.cell(infoTable, 2, 0, "L: " + str.tostring(atr_long, "#.##"), text_color = atr_col_long)
else if barstate.islast and not showTable
    table.delete(infoTable)