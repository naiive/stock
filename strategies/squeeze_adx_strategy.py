# -*- coding: utf-8 -*-
"""
Aè‚¡å…¨å¸‚åœºæ‰«æç­–ç•¥ï¼ˆå« SQZ é‡Šæ”¾è¯„åˆ†ï¼‰

æ ¸å¿ƒæ€æƒ³ï¼š
1. å¤§è¶‹åŠ¿å‘ä¸Šï¼ˆEMA200 + ADXï¼‰
2. æ³¢åŠ¨è¢«é•¿æœŸå‹ç¼©ï¼ˆSQZ ON â‰¥ 6ï¼‰
3. å½“å¤©åˆšé‡Šæ”¾ï¼ˆON â†’ OFFï¼‰
4. ç¬¬ä¸€æ ¹äº®ç»¿åŠ¨èƒ½æŸ±
5. ç”¨å‰ 6 æ—¥æŸ±çŠ¶é¢œè‰²ç»™â€œé‡Šæ”¾è´¨é‡â€æ‰“åˆ†
"""

import pandas as pd

# ADX + DI æŒ‡æ ‡ï¼ˆåˆ¤æ–­è¶‹åŠ¿å¼ºåº¦ï¼‰
from indicators.adx_di_indicator import adx_di_indicator

# ATR æŒ‡æ ‡ï¼ˆè®¡ç®—æ­¢æŸï¼‰
from indicators.atr_indicator import atr_indicator

# Squeeze Momentumï¼ˆæŒ¤å‹é‡Šæ”¾æ ¸å¿ƒæŒ‡æ ‡ï¼‰
from indicators.squeeze_momentum_indicator import squeeze_momentum_indicator


# ==================================================
# SQZMOM é¢œè‰²æ˜ å°„ï¼ˆç»Ÿä¸€æˆå››ç§ï¼‰
# ==================================================
COLOR_MAP = {
    'lime': 'ç»¿|äº®',     # å¼ºå¤šå¤´åŠ¨èƒ½
    'green': 'ç»¿|æš—',    # å¼±å¤šå¤´åŠ¨èƒ½
    'red': 'çº¢|äº®',      # å¼±ç©ºå¤´åŠ¨èƒ½
    'maroon': 'çº¢|æš—'    # å¼ºç©ºå¤´åŠ¨èƒ½ï¼ˆæ·±åº¦å‹ç¼©ï¼‰
}

# ==================================================
# SQZ é¢œè‰²è¯„åˆ†ç³»æ•°ï¼ˆçº¢è‰²æƒé‡å¤§ï¼‰
# ==================================================
COLOR_SCORE = {
    'çº¢|æš—': 1.0,
    'çº¢|äº®': 0.8,
    'ç»¿|æš—': 0.3,
    'ç»¿|äº®': 0.1
}

def run_strategy(df, symbol):
    """
    å•è‚¡ç¥¨æ‰«æå‡½æ•°
    å‘½ä¸­è¿”å› dict
    æœªå‘½ä¸­è¿”å› None
    """
    try:
        # ==========================================================
        # 1ï¸âƒ£ åŸºç¡€æ•°æ®é•¿åº¦æ£€æŸ¥
        # EMA200 / ADX / SQZ éƒ½éœ€è¦è¾ƒé•¿å†å²
        # ==========================================================
        if df is None or len(df) < 220:
            return None

        # ==========================================================
        # 2ï¸âƒ£ å½“æ—¥æ¶¨å¹…å¿…é¡»ä¸ºæ­£
        # é¿å…é€‰åˆ°åˆšé‡Šæ”¾ä½†å½“æ—¥è¢«ç ¸çš„æ ‡çš„
        # ==========================================================
        current_close = float(df['close'].iloc[-1])
        prev_close = float(df['close'].iloc[-2])

        pct_chg = (current_close - prev_close) / prev_close * 100
        if pct_chg <= 0:
            return None

        # ==========================================================
        # 3ï¸âƒ£ ä»·æ ¼å¿…é¡»ç«™åœ¨ EMA200 ä¸Š
        # ä¿è¯åªåœ¨é•¿æœŸä¸Šå‡è¶‹åŠ¿ä¸­æ‰¾æœºä¼š
        # ==========================================================
        ema200 = df['close'].rolling(200).mean().iloc[-1]
        if current_close <= ema200:
            return None

        # ==========================================================
        # 4ï¸âƒ£ ADX è¶‹åŠ¿å¼ºåº¦è¿‡æ»¤
        # ADX > 25 è¡¨ç¤ºè¶‹åŠ¿æ˜ç¡®
        # ==========================================================
        df = adx_di_indicator(df, length=14, threshold=25)
        adx_val = df.iloc[-1].get('adx')

        if pd.isna(adx_val) or adx_val <= 25:
            return None

        # ==========================================================
        # 5ï¸âƒ£ è®¡ç®— SQZMOMï¼ˆæŒ¤å‹åŠ¨èƒ½ï¼‰
        # ==========================================================
        df = squeeze_momentum_indicator(
            df,
            lengthKC=20,          # KC å‘¨æœŸ
            multKC=1.5,           # KC å€æ•°
            useTrueRange=True
        )

        last = df.iloc[-1]       # ä»Šå¤©
        prev = df.iloc[-2]       # æ˜¨å¤©

        sqz_status = last.get('sqz_status')        # ON / OFF
        prev_status = prev.get('sqz_status')
        sqz_hcolor = last.get('sqz_hcolor')        # åŠ¨èƒ½æŸ±é¢œè‰²
        prev_sqz_id = pd.to_numeric(
            prev.get('sqz_id'),
            errors='coerce'
        )

        # ==========================================================
        # 6ï¸âƒ£ SQZ é‡Šæ”¾ä¿¡å·å®šä¹‰
        # æ¡ä»¶è§£é‡Šï¼š
        # â‘  æ˜¨å¤©è¿˜åœ¨æŒ¤å‹ï¼ˆONï¼‰
        # â‘¡ ä»Šå¤©åˆšé‡Šæ”¾ï¼ˆOFFï¼‰
        # â‘¢ æŒ¤å‹æŒç»­ â‰¥ 6 å¤©
        # â‘£ ç¬¬ä¸€æ ¹äº®ç»¿æŸ±
        # ==========================================================
        if not (
            sqz_status == 'OFF' and
            prev_status == 'ON' and
            prev_sqz_id >= 6 and
            sqz_hcolor == 'lime'
        ):
            return None

        # ==========================================================
        # 7ï¸âƒ£ æå–ä¿¡å·å‰ 6 å¤©çš„æŸ±çŠ¶é¢œè‰²
        # å‰1æ—¥ = æ˜¨å¤©
        # ==========================================================
        raw_colors = (
            df['sqz_hcolor']
            .iloc[-7:-1]      # ä¸å«å½“å¤©
            .tolist()[::-1]   # åè½¬é¡ºåº
        )

        color_cols = {}
        for i in range(6):
            raw = raw_colors[i] if i < len(raw_colors) else None
            color_cols[f"å‰{i+1}æ—¥"] = COLOR_MAP.get(raw, 'æœªçŸ¥')

        # ==========================================================
        # 8ï¸âƒ£ SQZ é‡Šæ”¾è¯„åˆ†
        # è¶Šé è¿‘ä¿¡å·æ—¥ï¼Œçº¢è‰²æƒé‡è¶Šé«˜
        # ==========================================================
        score = 0.0
        for i in range(6):
            color_name = color_cols.get(f"å‰{i+1}æ—¥")

            weight = 6 - i   # å‰1æ—¥æƒé‡6ï¼Œå‰6æ—¥æƒé‡1
            color_factor = COLOR_SCORE.get(color_name, 0)

            score += weight * color_factor

        score = round(score, 2)

        # ==========================================================
        # 9ï¸âƒ£ ATR æ­¢æŸè®¡ç®—
        # ==========================================================
        df = atr_indicator(df, length=14, multiplier=1.5)
        last_atr = df.iloc[-1]

        # ==========================================================
        # ğŸ”Ÿ è¿”å›æ‰«æç»“æœ
        # ==========================================================
        return {
            "æ—¥æœŸ": str(last.get('date')),
            "ä»£ç ": symbol,
            "å½“å‰ä»·": round(current_close, 2),
            "æ¶¨å¹…(%)": round(pct_chg, 2),
            # å‰ 6 æ—¥æŸ±çŠ¶é¢œè‰²
            **color_cols,
            # SQZ é‡Šæ”¾è´¨é‡è¯„åˆ†
            "SQZé‡Šæ”¾è¯„åˆ†": score,
            # ATR åŠ¨æ€æ­¢æŸ
            "å»ºè®®æ­¢æŸä»·": round(last_atr.get('atr_long_stop'), 2)
        }

    except Exception:
        # æ‰«æåœºæ™¯ä¸‹ï¼Œå•ç¥¨å¼‚å¸¸ç›´æ¥è·³è¿‡
        return None
